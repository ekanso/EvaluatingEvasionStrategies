clear;
close all;

set(groot,'defaultLineLineWidth',2);
set(groot,'defaultFigureColor','w');
set(groot,'defaultTextFontsize',22);
set(groot,'defaultAxesFontsize',22);
set(groot,'defaultPolarAxesFontsize',22);
set(groot,'defaultTextInterpreter','latex');
set(groot,'defaultPolarAxesTickLabelInterpreter','latex');
set(groot,'defaultAxesTickLabelInterpreter','latex');
set(groot,'defaultAxesLineWidth',1);
%% predator frame
load('kelsey_datasets.mat');

wec = trans(1).head-trans(1).com;
wec2 = trans(2).head-trans(2).com;
wec3 = trans(3).head-trans(3).com;
% wec(:,1:2) = wec(:,1:2)./sqrt((wec(:,1).^2+wec(:,2).^2));
% wec2(:,1:2) = wec2(:,1:2)./sqrt((wec2(:,1).^2+wec2(:,2).^2));
% wec3(:,1:2) = wec3(:,1:2)./sqrt((wec3(:,1).^2+wec3(:,2).^2));
vec = trans(1).head-trans(1).tail;
vec2 = trans(2).head-trans(2).tail;
vec3 = trans(3).head-trans(3).tail;
% vec(:,1:2) = vec(:,1:2)./sqrt((vec(:,1).^2+vec(:,2).^2));
% vec2(:,1:2) = vec2(:,1:2)./sqrt((vec2(:,1).^2+vec2(:,2).^2));
% vec3(:,1:2) = vec3(:,1:2)./sqrt((vec3(:,1).^2+vec3(:,2).^2));
uec = trans(1).head2-trans(1).com2;
uec2 = trans(2).head2-trans(2).com2;
uec3 = trans(3).head2-trans(3).com2;
uec(:,1:2) = uec(:,1:2)./sqrt((uec(:,1).^2+uec(:,2).^2)).*sqrt((vec(:,1).^2+vec(:,2).^2));
uec2(:,1:2) = uec2(:,1:2)./sqrt((uec2(:,1).^2+uec2(:,2).^2)).*sqrt((vec2(:,1).^2+vec2(:,2).^2));
uec3(:,1:2) = uec3(:,1:2)./sqrt((uec3(:,1).^2+uec3(:,2).^2)).*sqrt((vec3(:,1).^2+vec3(:,2).^2));

% scalef = 1/0.1765;
figure,hold on;
quiver(trans(1).tail(:,1),trans(1).tail(:,2),vec(:,1),vec(:,2),'b','AutoScale','off','LineWidth',1.5,'showarrowhead','of');
% quiver(trans(2).tail(:,1),trans(2).tail(:,2),vec2(:,1),vec2(:,2),'r','AutoScale','off','LineWidth',1.5,'showarrowhead','off');
% quiver(trans(3).tail(:,1),trans(3).tail(:,2),vec3(:,1),vec3(:,2),'g','AutoScale','off','LineWidth',1.5,'showarrowhead','off');
scatter(raw(1).pred(1),raw(1).pred(2),'r');
% quiver(trans(1).com(:,1),trans(1).com(:,2),trans(1).com2(:,1)-trans(1).com(:,1),trans(1).com2(:,2)-trans(1).com(:,2),'k','AutoScale','off','LineWidth',1.5,'showarrowhead','off');
% quiver(trans(2).com(:,1),trans(2).com(:,2),trans(2).com2(:,1)-trans(2).com(:,1),trans(2).com2(:,2)-trans(2).com(:,2),'k','AutoScale','off','LineWidth',1.5,'showarrowhead','off');
% quiver(trans(3).com(:,1),trans(3).com(:,2),trans(3).com2(:,1)-trans(3).com(:,1),trans(3).com2(:,2)-trans(3).com(:,2),'k','AutoScale','off','LineWidth',1.5,'showarrowhead','off');

quiver(trans(1).tail(:,1),trans(1).tail(:,2),uec(:,1),uec(:,2),'k','AutoScale','off','LineWidth',1.5,'showarrowhead','off');
% quiver(trans(2).tail(:,1),trans(2).tail(:,2),uec2(:,1),uec2(:,2),'k','AutoScale','off','LineWidth',1.5,'showarrowhead','off');
% quiver(trans(3).tail(:,1),trans(3).tail(:,2),uec3(:,1),uec3(:,2),'k','AutoScale','off','LineWidth',1.5,'showarrowhead','off');
plot([0.04,0.05],[0.04,0.04]);
axis equal

%% V=2
idx = 1;
len = length(trans(idx).frames1);
tailToHead = trans(idx).head(1:len,1:2)-trans(idx).tail(1:len,1:2);
prey_length = sqrt(dot(tailToHead,tailToHead,2));
alpha = trans(idx).head(1:len,1:2)-trans(idx).com(1:len,1:2);
alpha_after = trans(idx).head2(1:len,1:2)-trans(idx).com2(1:len,1:2);
% R = trans(idx).frames1(1:len)/250*[0.2 0 0];
R = [0 0 0];
r = trans(idx).com(1:len,1:2);
r_after = trans(idx).com2(1:len,1:2);
duration = (trans(idx).frames2(1:len) - trans(idx).frames1(1:len))/250;
R_r = R(:,1:2)-r;
% R_r = trans(idx).pred(1:2) - trans(idx).com(1:len,1:2);
R_r_normalized = R_r./sqrt(R_r(:,1).^2+R_r(:,2).^2);
alpha_normalized = alpha./sqrt(alpha(:,1).^2+alpha(:,2).^2);
alpha_after_normalized = alpha_after./sqrt(alpha_after(:,1).^2+alpha_after(:,2).^2);
cosPhi = dot(alpha_normalized,R_r_normalized,2);
cosTheta = dot(alpha_after_normalized,alpha_normalized,2);
distance = sqrt(dot(r,r,2));
moving = sqrt(dot(r-r_after,r-r_after,2));
prey_spd = moving./duration;
duration_02 = duration;
%% V=11
idx = 2;
len = length(trans(idx).frames1);
tailToHead = trans(idx).head(1:len,1:2)-trans(idx).tail(1:len,1:2);
prey_length = sqrt(dot(tailToHead,tailToHead,2));
alpha = trans(idx).head(1:len,1:2)-trans(idx).com(1:len,1:2);
alpha_after = trans(idx).head2(1:len,1:2)-trans(idx).com2(1:len,1:2);
% R = trans(idx).frames1(1:len)/250*[0.2 0 0];
R = [0 0 0];
r = trans(idx).com(1:len,1:2);
r_after = trans(idx).com2(1:len,1:2);
duration = (trans(idx).frames2(1:len) - trans(idx).frames1(1:len))/250;
R_r = R(:,1:2)-r;
% R_r = trans(idx).pred(1:2) - trans(idx).com(1:len,1:2);
R_r_normalized = R_r./sqrt(R_r(:,1).^2+R_r(:,2).^2);
alpha_normalized = alpha./sqrt(alpha(:,1).^2+alpha(:,2).^2);
alpha_after_normalized = alpha_after./sqrt(alpha_after(:,1).^2+alpha_after(:,2).^2);
cosPhi = dot(alpha_normalized,R_r_normalized,2);
cosTheta = dot(alpha_after_normalized,alpha_normalized,2);
distance = sqrt(dot(r,r,2));
moving = sqrt(dot(r-r_after,r-r_after,2));
prey_spd = moving./duration;
duration_11 = duration(cosTheta<2);
%% V=20
idx = 3;
len = length(trans(idx).frames1);
tailToHead = trans(idx).head(1:len,1:2)-trans(idx).tail(1:len,1:2);
prey_length = sqrt(dot(tailToHead,tailToHead,2));
alpha = trans(idx).head(1:len,1:2)-trans(idx).com(1:len,1:2);
alpha_after = trans(idx).head2(1:len,1:2)-trans(idx).com2(1:len,1:2);
% R = trans(idx).frames1(1:len)/250*[0.2 0 0];
R = [0 0 0];
r = trans(idx).com(1:len,1:2);
r_after = trans(idx).com2(1:len,1:2);
duration = (trans(idx).frames2(1:len) - trans(idx).frames1(1:len))/250;
R_r = R(:,1:2)-r;
% R_r = trans(idx).pred(1:2) - trans(idx).com(1:len,1:2);
R_r_normalized = R_r./sqrt(R_r(:,1).^2+R_r(:,2).^2);
alpha_normalized = alpha./sqrt(alpha(:,1).^2+alpha(:,2).^2);
alpha_after_normalized = alpha_after./sqrt(alpha_after(:,1).^2+alpha_after(:,2).^2);
cosPhi = dot(alpha_normalized,R_r_normalized,2);
cosTheta = dot(alpha_after_normalized,alpha_normalized,2);
distance = sqrt(dot(r,r,2));
moving = sqrt(dot(r-r_after,r-r_after,2));
prey_spd = moving./duration;
duration_20 = duration;
%% prey frame
load('evasionData.mat');
% get rid of the case with 0 time duration
phi = data.Phi(isfinite(data.U));
u   = data.U(isfinite(data.U));
v   = data.V(isfinite(data.U))*0.01;
lam = data.Lambda(isfinite(data.U));
theta = data.Delta(isfinite(data.U));
d = data.D(isfinite(data.U));
theta = wrapTo2Pi(theta);

% original
phi = data.Phi;
u   = data.U;
v   = data.V/100;
lam = data.Lambda;
theta = data.Delta;
d = data.D;
theta = wrapTo2Pi(theta);
theta(theta>pi) = 2*pi-theta(theta>pi);

phi_02 = phi(v == 0.02);
phi_11 = phi(v == 0.11);
phi_20 = phi(v == 0.2);
lam_02 = lam(v == 0.02);
lam_11 = lam(v == 0.11);
lam_20 = lam(v == 0.2);
u_02 = u(v == 0.02);
u_11 = u(v == 0.11);
u_20 = u(v == 0.2);
theta_02 = theta(v == 0.02);
theta_11 = theta(v == 0.11);
theta_20 = theta(v == 0.2);
d_02 = d(v == 0.02);
d_11 = d(v == 0.11);
d_20 = d(v == 0.2);

figure,hold on;
scalef = 0.003;
quiver(d_02.*cos(phi_02),d_02.*sin(phi_02),scalef*cos(phi_02+pi+lam_02),scalef*sin(phi_02+pi+lam_02),'Color',[0 0.3 0.65],'AutoScale','off','LineWidth',1.5,'showarrowhead','off');
quiver(d_11.*cos(phi_11),d_11.*sin(phi_11),scalef*cos(phi_11+pi+lam_11),scalef*sin(phi_11+pi+lam_11),'Color',[0.85 0.25 0.15],'AutoScale','off','LineWidth',1.5,'showarrowhead','off');
quiver(d_20.*cos(phi_20),d_20.*sin(phi_20),scalef*cos(phi_20+pi+lam_20),scalef*sin(phi_20+pi+lam_20),'Color',[0.4 0.6 0.2],'AutoScale','off','LineWidth',1.5,'showarrowhead','off');

% quiver(d_02.*cos(phi_02),d_02.*sin(phi_02),cos(phi_02+pi+lam_02),sin(phi_02+pi+lam_02),'k','MaxHeadSize',0.05,'AutoScaleFactor',0.25,'LineWidth',2.5);
% quiver(d_11.*cos(phi_11),d_11.*sin(phi_11),cos(phi_11+pi+lam_11),sin(phi_11+pi+lam_11),'k','MaxHeadSize',0.05,'AutoScaleFactor',0.25,'LineWidth',2.5);
% quiver(d_20.*cos(phi_20),d_20.*sin(phi_20),cos(phi_20+pi+lam_20),sin(phi_20+pi+lam_20),'k','MaxHeadSize',0.05,'AutoScaleFactor',0.25,'LineWidth',2.5);
axis equal off;
plot(linspace(-0.06,0.06,11),zeros(1,11),'Color',[0.6,0.6,0.6],'LineWidth',1.5);
plot(zeros(1,11),linspace(-0.06,0.06,11),'Color',[0.6,0.6,0.6],'LineWidth',1.5);
plot([0,0.01],[0,0],'linewidth',2,'color','k');
%% histogram of duration t
figure('position',[276,534,1073,339]);c = get(gca,'colororder');
subplot(1,3,1);
histogram(duration_02*1000,15,'BinLimits',[0,60],'Normalization','Probability','facecolor',c(1,:));
xlabel('duration [ms]');
ylabel('probability');ylim([0,0.6]);
title('slow predator');
xlim([0,60]);xticks(0:20:60);
subplot(1,3,2);
histogram(duration_11*1000,15,'BinLimits',[0,60],'Normalization','Probability','facecolor',c(2,:));
xlabel('duration [ms]');
ylabel('probability');ylim([0,0.6]);
title('medium speed predator');
xlim([0,60]);xticks(0:20:60);
subplot(1,3,3);
histogram(duration_20*1000,15,'BinLimits',[0,60],'Normalization','Probability','facecolor',c(3,:));
xlabel('duration [ms]');
ylabel('probability');ylim([0,0.6]);
title('fast predator');
xlim([0,60]);xticks(0:20:60);

%%  t vs theta

figure('position',[276,534,1073,339]);c = get(gca,'colororder');
subplot(1,3,1);
plot(duration_02*1000,theta_02,'o','color',c(1,:));
xlabel('duration [ms]');
ylabel('turn angle $\theta$');
title('slow predator');
xlim([0,60]);xticks(0:20:60);
ylim([0,pi]);yticks(0:pi/2:pi);yticklabels({'0','$\pi/2$','$\pi$'});
subplot(1,3,2);
plot(duration_11*1000,theta_11,'o','color',c(2,:));
xlabel('duration [ms]');
ylabel('turn angle $\theta$');
title('medium speed predator');
xlim([0,60]);xticks(0:20:60);
ylim([0,pi]);yticks(0:pi/2:pi);yticklabels({'0','$\pi/2$','$\pi$'});
subplot(1,3,3);
plot(duration_20*1000,theta_20,'o','color',c(3,:));
xlabel('duration [ms]');
ylabel('turn angle $\theta$');
title('fast predator');
xlim([0,60]);xticks(0:20:60);
ylim([0,pi]);yticks(0:pi/2:pi);yticklabels({'0','$\pi/2$','$\pi$'});
%% prey speed u distribution
figure('position',[276,534,1073,339]);
subplot(1,3,1);
h = histogram(u_02,15,'BinLimits',[0,0.15],'Normalization','probability','facecolor',c(1,:));
hold on; xline(mean(u_02(u_02<100)),'--k','linewidth',1.5);
xlabel('prey speed $u$ [m/s]');
ylabel('probability');ylim([0,0.2]);
title('slow predator');
subplot(1,3,2);
h = histogram(u_11(u_11<100),15,'BinLimits',[0,0.15],'Normalization','probability','facecolor',c(2,:));
hold on; xline(mean(u_11(u_11<100)),'--k','linewidth',1.5);
xlabel('prey speed $u$ [m/s]');ylabel('probability');ylim([0,0.2]);
title('medium speed predator');
subplot(1,3,3);
h = histogram(u_20(u_20<100),15,'BinLimits',[0,0.15],'Normalization','probability','facecolor',c(3,:));
hold on; xline(mean(u_20(u_20<100)),'--k','linewidth',1.5);
xlabel('prey speed $u$ [m/s]');
ylabel('probability');ylim([0,0.2]);
title('fast predator');
%% u/v distribution
figure('position',[276,534,1073,339]);
subplot(1,3,1);
h = histogram(u_02/0.02,15,'BinLimits',[0,7],'Normalization','probability','facecolor',c(1,:));
hold on; xline(mean(u_02(u_02<100))/0.02,'--k','linewidth',1.5);
% xlabel('prey speed/predator speed, u/v');
ylabel('probability');ylim([0,0.25]);
title('slow predator');
subplot(1,3,2);
h = histogram(u_11(u_11<100)/0.11,15,'BinLimits',[0,1.5],'Normalization','probability','facecolor',c(2,:));
hold on; xline(mean(u_11(u_11<100))/0.11,'--k','linewidth',1.5);
xlabel('prey speed/predator speed, $u/v$');ylabel('probability');ylim([0,0.25]);
title('medium speed predator');
subplot(1,3,3);
h = histogram(u_20(u_20<100)/0.2,15,'BinLimits',[0,1],'Normalization','probability','facecolor',c(3,:));
hold on; xline(mean(u_20(u_20<100))/0.2,'--k','linewidth',1.5);
% xlabel('prey speed/predator speed, u/v');
ylabel('probability');ylim([0,0.25]);
title('fast predator');
